pipeline {
  agent any
  environment {
    IMAGE_NAME = "delivery_metrics:local"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Pre-check Docker') {
      steps {
        script {
          def rc = sh(script: 'which docker >/dev/null 2>&1 && echo 0 || echo 1', returnStdout: true).trim()
          if (rc != '0') {
            error "docker CLI not found inside Jenkins container. Ensure docker is available or use a docker agent."
          }
          // check docker daemon
          def infoRc = sh(script: 'docker info >/dev/null 2>&1; echo $?', returnStdout: true).trim()
          if (infoRc != '0') {
            error "Docker daemon not accessible. Make sure docker.sock is mounted and daemon is running on host."
          }
          echo "Docker CLI & daemon accessible"
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -t $IMAGE_NAME .'
      }
    }

    stage('Deploy Exporter') {
      steps {
        sh '''
          docker rm -f delivery_exporter || true
          docker run -d --name delivery_exporter -p 8000:8000 $IMAGE_NAME
        '''
      }
    }

    stage('Start Monitoring Stack') {
      steps {
        sh '''
          # remove old ones if present
          docker rm -f prometheus || true
          docker rm -f grafana || true

          # start Prometheus (bind to the workspace config)
          docker run -d --name prometheus -p 9090:9090 \
            -v $WORKSPACE/prometheus.yml:/etc/prometheus/prometheus.yml \
            -v $WORKSPACE/alert_rules.yml:/etc/prometheus/alert_rules.yml \
            prom/prometheus

          docker run -d --name grafana -p 3000:3000 grafana/grafana
        '''
      }
    }

    stage('Verify') {
      steps {
        sh '''
          echo "Containers:"
          docker ps --filter "name=delivery_exporter|prometheus|grafana" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          # quick curl checks (may fail if services take time to start)
          sleep 3
          echo "Prometheus targets:"
          curl -sS http://host.docker.internal:9090/api/v1/targets || true
        '''
      }
    }
  }

  post {
    success { echo "Pipeline succeeded" }
    failure { echo "Pipeline failed" }
  }
}
