#include <tunables/global>

profile docker_myprofile flags=(attach_disconnected,mediate_deleted) {

  ## --- BASIC ALLOWS ---
  capability net_bind_service,
  network inet stream,
  network inet6 stream,

  ## --- PYTHON + SHARED LIBS ---
  /lib/**                rm,
  /lib64/**              rm,
  /usr/lib/**            rm,
  /usr/local/lib/**      rm,

  ## --- PYTHON BINARIES + LOADER ---
  /usr/bin/**            mr,
  /usr/local/bin/**      mr,
  /bin/**                mr,

  ## --- DOCKER OVERLAY STORAGE ---
  /var/lib/docker/**     r,
  /run/docker/**         r,
  /run/containers/**     r,
  /var/lib/containers/** r,

  ## --- RUNTIME NEEDED ---
  /proc/**               r,
  /dev/**                r,
  /sys/**                r,

  ## --- APP DIRECTORY ---
  /app/**                rwk,

  ## --- PREVENT HOST WRITES ---
  deny /etc/**           w,
  deny /var/**           w,
  deny capability sys_admin,

  ## --- ALLOW STOP/KILL ---
  # VERY IMPORTANT: allow receiving signals from dockerd/runc
  signal receive,
  signal send,
  
  # This allows the process to receive SIGTERM/SIGKILL from host tools
  # without this, docker stop/rm simply cannot work
}
